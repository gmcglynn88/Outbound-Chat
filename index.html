<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Genesys Dummy Email Interaction</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 2rem; max-width: 480px; margin: auto; }
        label { display: block; margin-top: 1rem; }
        select, input, button, textarea { width: 100%; padding: 0.5rem; margin-top: 0.5rem; }
        button { margin-top: 2rem; background: #0072ce; color: white; border: none; border-radius: 5px; }
        textarea { height: 80px; }
    </style>
</head>
<body>
    <h2>Create Dummy Genesys Email Interaction</h2>
    <button id="login-btn">Login with Genesys</button>
    <div id="main-form" style="display:none;">
        <label>Queue:
            <select id="queue-select"></select>
        </label>
        <label>Agent:
            <select id="user-select"></select>
        </label>
        <label>Interaction Label/Content:
            <input id="interaction-label" placeholder="e.g. Customer Complaint" value="Test Interaction" />
        </label>
        <label>Subject:
            <input id="subject" placeholder="Email subject" value="Test Interaction" />
        </label>
        <label>Message Content:
            <textarea id="message-content" placeholder="Enter detailed content here..."></textarea>
        </label>
        <label>External Reference:
            <input id="external-ref" placeholder="https://..." />
        </label>
        <button id="create-btn">Create Interaction</button>
    </div>
    <div id="result"></div>

<script>
const clientId = '96d0dde8-a96f-44fb-b039-5e578a1e78b3';
const redirectUri = 'https://gmcglynn88.github.io/Outbound-Chat/';
const oauthUrl = `https://login.mypurecloud.ie/oauth/authorize?client_id=${clientId}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}`;
let accessToken = null;

document.getElementById('login-btn').onclick = () => {
    window.location = oauthUrl;
};

window.onload = async () => {
    // OAuth token extraction from URL fragment
    const hash = window.location.hash;
    if (hash.startsWith('#access_token=')) {
        accessToken = hash.match(/access_token=([^&]*)/)[1];
        document.getElementById('login-btn').style.display = 'none';
        document.getElementById('main-form').style.display = 'block';

        // Load dropdown data
        await loadQueues();
        await loadUsers();
    }
};

async function fetchAll(url) {
    let items = [];
    let page = 1, pageSize = 100, total = 0;
    do {
        const res = await fetch(`${url}?pageNumber=${page}&pageSize=${pageSize}`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        if (!res.ok) throw new Error('API Error: ' + res.status);
        const data = await res.json();
        total = data.total || (data.entities ? data.entities.length : 0);
        items = items.concat(data.entities || []);
        page++;
    } while (items.length < total);
    return items;
}

async function loadQueues() {
    const queues = await fetchAll('https://api.mypurecloud.ie/api/v2/routing/queues');
    const select = document.getElementById('queue-select');
    select.innerHTML = queues.map(q =>
        `<option value="${q.id}">${q.name}</option>`
    ).join('');
}

async function loadUsers() {
    const users = await fetchAll('https://api.mypurecloud.ie/api/v2/users');
    const select = document.getElementById('user-select');
    select.innerHTML = users.map(u =>
        `<option value="${u.id}">${u.name} (${u.email})</option>`
    ).join('');
}

document.getElementById('create-btn').onclick = async () => {
    const queueId = document.getElementById('queue-select').value;
    const userId = document.getElementById('user-select').value;
    const externalRef = document.getElementById('external-ref').value;
    const subject = document.getElementById('subject').value;
    const interactionLabel = document.getElementById('interaction-label').value;
    const messageContent = document.getElementById('message-content').value || "No content provided";
    
    const body = {
        queueId,
        provider: 'QualityForm',
        direction: 'INBOUND',
        fromName: interactionLabel,  // Changed from 'External Work' to user-provided label
        fromAddress: 'no-reply@test.com',
        subject: subject,
        priority: 1,
        autoAnswer: true,
        attributes: { 
            'External Link': externalRef,
            'isDummyInteraction': 'true',
            'keepOpen': 'true',
            'InteractionContent': messageContent  // Adding the detailed content as an attribute
        },
        toAddresses: ['agent@test.com'],
        participantInfo: {
            userId: userId
        },
        // Adding the message body to the email
        htmlBody: `<p>${messageContent.replace(/\n/g, '<br>')}</p>`
    };

    try {
        const res = await fetch('https://api.mypurecloud.ie/api/v2/conversations/emails', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
        });
        
        if (!res.ok) {
            const errorData = await res.json();
            throw new Error(`Create failed: ${res.status} - ${errorData.message || 'Unknown error'}`);
        }
        
        const data = await res.json();
        
        // Optionally add the agent as a participant if not already done
        await addParticipant(data.id, userId);
        
        document.getElementById('result').innerHTML =
            `<b>Success!</b> Interaction created with label: "${interactionLabel}"<br>
             Conversation ID: ${data.id}<br>
             The interaction should now appear in the agent's workspace.`;
    } catch (err) {
        console.error('Error creating interaction:', err);
        document.getElementById('result').innerHTML =
            `<b style="color:red;">Error:</b> ${err.message}`;
    }
};

async function addParticipant(conversationId, userId) {
    try {
        const res = await fetch(`https://api.mypurecloud.ie/api/v2/conversations/${conversationId}/participants`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                userId: userId,
                purpose: 'agent'
            })
        });
        
        if (!res.ok) {
            console.warn('Failed to add participant, but interaction was created');
        }
    } catch (err) {
        console.warn('Error adding participant:', err);
    }
}
</script>
</body>
</html>
