<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genesys Targeted Interaction Creator</title>
    <style>
        /* Your existing styles remain the same */
    </style>
</head>
<body>
    <!-- Your existing HTML remains the same -->
    
<script>
// Your existing constants and authentication code remain the same

async function forceAssignToAgent(conversationId, userId) {
    // First get the participant ID for the agent
    const participantsUrl = `https://api.mypurecloud.ie/api/v2/conversations/emails/${conversationId}/participants`;
    const participantsRes = await fetch(participantsUrl, {
        headers: { 'Authorization': `Bearer ${accessToken}` }
    });
    
    if (!participantsRes.ok) throw new Error('Failed to get participants');
    
    const participants = await participantsRes.json();
    const agentParticipant = participants.find(p => p.purpose === 'agent');
    
    if (!agentParticipant) throw new Error('No agent participant found');
    
    // Prepare the participant update payload according to the schema
    const updatePayload = {
        wrapup: {
            code: "TARGETED_ASSIGNMENT",
            name: "Targeted Assignment",
            notes: "Directly assigned via Targeted Interaction Tool",
            tags: ["forced_assignment"],
            durationSeconds: 0,
            provisional: true,
            disableEndTimeUpdates: true
        },
        state: "connected", // or "alerting" depending on your needs
        recording: true,
        muted: false,
        confined: false,
        held: false,
        wrapupSkipped: true,
        attributes: {
            'isForcedAssignment': 'true',
            'assignmentSource': 'Targeted Tool',
            'skipQueue': 'true'
        }
    };

    const updateUrl = `https://api.mypurecloud.ie/api/v2/conversations/emails/${conversationId}/participants/${agentParticipant.id}`;
    
    const response = await fetch(updateUrl, {
        method: 'PATCH',
        headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(updatePayload)
    });
    
    if (!response.ok) {
        const errorText = await response.text();
        throw new Error(`Failed to force assign to agent: ${errorText}`);
    }
    
    return response.json();
}

document.getElementById('create-btn').onclick = async () => {
    const queueId = "2fec5d88-bbf0-41bb-ab5a-95199438a2aa";
    const userId = document.getElementById('user-select').value;
    const interactionLabel = document.getElementById('interaction-label').value;
    
    if (!interactionLabel || interactionLabel.trim() === '') {
        showError('Please enter a reference for the interaction');
        return;
    }
    
    showLoader(true);
    document.getElementById('result').style.display = 'none';
    
    try {
        // Step 1: Create the conversation with queue association
        const conversationBody = {
            queueId: queueId,
            direction: 'INBOUND',
            fromName: interactionLabel,
            fromAddress: 'targeted@company.com',
            subject: interactionLabel,
            priority: 1,
            autoAnswer: true,
            provider: 'external',
            attributes: {
                'targetedAgentId': userId,
                'isForcedAssignment': 'true',
                'interactionLabel': interactionLabel,
                'createdVia': 'Targeted Interaction Tool',
                'skipQueue': 'true'
            },
            toAddresses: ['support@company.com'],
            htmlBody: `
                <div style="font-family: Aptos, sans-serif; line-height: 1.5;">
                    <h3 style="color: #63AB8F;">${interactionLabel}</h3>
                    <p>This interaction was specifically assigned to you.</p>
                    <p style="color: #666; font-size: 0.9em;">
                        Created: ${new Date().toLocaleString()}
                    </p>
                </div>
            `,
            participants: [{
                userId: userId,
                purpose: 'agent',
                address: 'agent@company.com',
                attributes: {
                    'isForcedAssignment': 'true',
                    'assignmentSource': 'Targeted Tool',
                    'skipQueue': 'true'
                }
            }]
        };

        const convRes = await fetch('https://api.mypurecloud.ie/api/v2/conversations/emails', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(conversationBody)
        });
        
        if (!convRes.ok) {
            const errorText = await convRes.text();
            throw new Error(`Failed to create conversation: ${errorText}`);
        }
        
        const conversation = await convRes.json();
        
        // Step 2: Force assignment to agent using the schema
        await forceAssignToAgent(conversation.id, userId);
        
        const agentName = document.getElementById('user-select').selectedOptions[0].text;
        
        showSuccess(`
            <strong>Interaction successfully created and assigned</strong>
            <p style="margin-top: 0.5rem; font-size: 0.9em; color: #666;">
                The interaction has been directly assigned to ${agentName} while remaining associated with the queue.
                <br>Conversation ID: ${conversation.id}
            </p>
        `);
    } catch (err) {
        showError(`
            <strong>Error during creation</strong>
            <p style="margin: 0.5rem 0 0;">${err.message}</p>
            <p style="font-size: 0.9em; color: #666; margin-top: 0.5rem;">
                Please check the console for more details.
            </p>
        `);
        console.error('Detailed error:', err);
    } finally {
        showLoader(false);
    }
};
</script>
</body>
</html>
