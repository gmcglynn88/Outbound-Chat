<script>
async function createInteraction(token) {
  const queueId = document.getElementById('queueSelect').value;
  const userId = document.getElementById('userSelect').value;
  const externalReference = document.getElementById('externalReference').value;

  try {
    // 1. Create a web messaging interaction (most reliable for persistent work items)
    const convResponse = await fetch('https://api.mypurecloud.ie/api/v2/conversations/webmessaging', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        queueId: queueId,
        direction: 'INBOUND',
        externalContactId: '00000000-0000-0000-0000-000000000000', // Required dummy contact
        attributes: {
          'ExternalReference': externalReference,
          'ExternalWork': 'true',
          'subject': externalReference || 'External Work Item',
          'customStatus': 'Pending' // Helps prevent auto-close
        }
      })
    });

    if (!convResponse.ok) throw new Error(`Creation failed: ${await convResponse.text()}`);
    const conversation = await convResponse.json();
    const conversationId = conversation.id;

    // 2. Add a system message to stabilize the interaction
    await fetch(`https://api.mypurecloud.ie/api/v2/conversations/webmessaging/${conversationId}/messages`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        body: externalReference ? `Work Item: ${externalReference}` : 'New External Work Item',
        bodyType: 'standard'
      })
    });

    // 3. Assign to agent using participant endpoint (more reliable)
    const assignResponse = await fetch(`https://api.mypurecloud.ie/api/v2/conversations/${conversationId}/participants`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        userId: userId,
        purpose: 'agent'
      })
    });

    if (!assignResponse.ok) throw new Error(`Assignment failed: ${await assignResponse.text()}`);

    // 4. Verify interaction remains open
    const verifyResponse = await fetch(`https://api.mypurecloud.ie/api/v2/conversations/${conversationId}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const verifiedConv = await verifyResponse.json();
    
    if (verifiedConv.state !== 'active') {
      throw new Error('Interaction failed to stay active');
    }

    // Success
    document.getElementById('statusMessage').innerHTML = `
      Work item created successfully!<br>
      <a href="https://apps.mypurecloud.ie/conversation/${conversationId}" target="_blank">
        Open in PureCloud (ID: ${conversationId})
      </a>
    `;

  } catch (error) {
    console.error('Creation error:', error);
    document.getElementById('statusMessage').innerHTML = `
      <span style="color:red">Error: ${error.message}</span><br>
      ${error.response ? await error.response.text() : ''}
    `;
  }
}
</script>
