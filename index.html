<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>External Work Outbound Call</title>
  <link href="https://fonts.googleapis.com/css2?family=Proxima+Nova&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Proxima Nova',Arial,sans-serif; margin:20px; padding:20px }
    #logo-container { text-align:center; margin-bottom:20px }
    #logo { width:300px }
    label { display:block; margin-top:10px; font-weight:bold }
    select,input,button { width:100%; max-width:300px; padding:8px; margin-top:5px }
    #statusMessage { margin-top:20px; font-style:italic; color:#2a7f62 }
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/ExternalWorkCreation/main/Consultinglogo.png" alt="Company Logo">
  </div>

  <h1>External Work Outbound Call</h1>

  <label for="queueSelect">Select Queue:</label>
  <select id="queueSelect"></select>

  <label for="phoneNumber">Phone Number to Dial:</label>
  <input type="tel" id="phoneNumber" placeholder="e.g. +441234567890">

  <button id="startCallBtn">Place Call</button>
  <div id="statusMessage"></div>

  <script>
    // ‚Äî‚Äî‚Äî CONFIG ‚Äî‚Äî‚Äî
    const clientId     = '96d0dde8-a96f-44fb-b039-5e578a1e78b3';
    const redirectUri  = 'https://gmcglynn88.github.io/Outbound-Chat/';
    const responseType = 'token';
    // You‚Äôll need these scopes enabled on your OAuth client:
    const scopes = [
      'conversation.calls.create',
      'routing.queues.read'
    ];
    // ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî

    const oauthUrl = [
      'https://login.mypurecloud.ie/oauth/authorize?',
      `client_id=${clientId}`,
      `response_type=${responseType}`,
      `redirect_uri=${encodeURIComponent(redirectUri)}`,
      `scope=${encodeURIComponent(scopes.join(' '))}`,
      'state=callDemo'
    ].join('&');

    document.addEventListener('DOMContentLoaded', () => {
      const hash   = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const token  = params.get('access_token');
      if (!token) {
        window.location.replace(oauthUrl);
      } else {
        init(token);
      }
    });

    function init(token) {
      loadQueues(token);
      document.getElementById('startCallBtn')
              .addEventListener('click', () => placeCall(token));
    }

    async function loadQueues(token) {
      try {
        const res = await fetch('https://api.mypurecloud.ie/api/v2/routing/queues?pageSize=50', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        const data = await res.json();
        const sel  = document.getElementById('queueSelect');
        data.entities.forEach(q => sel.add(new Option(q.name, q.id)));
      } catch (err) {
        console.error('Failed to load queues:', err);
        document.getElementById('statusMessage')
                .innerText = `üôà Couldn‚Äôt load queues: ${err.message}`;
      }
    }

    async function placeCall(token) {
      const queueId  = document.getElementById('queueSelect').value;
      const toNumber = document.getElementById('phoneNumber').value.trim();
      const statusEl = document.getElementById('statusMessage');

      if (!queueId || !toNumber) {
        return statusEl.innerText = '‚ö†Ô∏è Please select a queue and enter a phone number.';
      }

      statusEl.innerText = 'üìû Placing call‚Ä¶';

      try {
        const resp = await fetch('https://api.mypurecloud.ie/api/v2/conversations/calls', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type':  'application/json'
          },
          body: JSON.stringify({
            queueId:   queueId,
            toAddress: toNumber
          })
        });
        if (!resp.ok) throw new Error(`${resp.status} ${resp.statusText}`);
        const call = await resp.json();
        statusEl.innerText = `‚úÖ Call ${call.id} initiated‚Äîagents in queue will be rung shortly.`;
      } catch (err) {
        console.error('Call error:', err);
        statusEl.innerText = `üòµ Oops, call failed: ${err.message}`;
      }
    }
  </script>
</body>
</html>
