<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Genesys Dummy Email Interaction</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 2rem; max-width: 480px; margin: auto; }
        label { display: block; margin-top: 1rem; }
        select, input, button { width: 100%; padding: 0.5rem; margin-top: 0.5rem; }
        button { margin-top: 2rem; background: #0072ce; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #result { margin-top: 2rem; font-size: 1.1em; }
    </style>
</head>
<body>
    <h2>Create Dummy Genesys Email Interaction</h2>
    <button id="login-btn">Login with Genesys</button>
    <div id="main-form" style="display:none;">
        <label>Queue:
            <select id="queue-select"></select>
        </label>
        <label>Agent:
            <select id="user-select"></select>
        </label>
        <label>External Reference:
            <input id="external-ref" placeholder="https://..." />
        </label>
        <button id="create-btn">Create Interaction</button>
    </div>
    <div id="result"></div>

<script>
const clientId = '35987d94-e13b-4da4-afd2-25b85bc1c3d6';
const redirectUri = 'https://gmcglynn88.github.io/ExternalWorkCreation/';
const oauthUrl = `https://login.mypurecloud.ie/oauth/authorize?client_id=${clientId}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}`;
let accessToken = null;

document.getElementById('login-btn').onclick = () => {
    window.location = oauthUrl;
};

window.onload = async () => {
    // OAuth token extraction from URL fragment
    const hash = window.location.hash;
    if (hash.startsWith('#access_token=')) {
        accessToken = hash.match(/access_token=([^&]*)/)[1];
        document.getElementById('login-btn').style.display = 'none';
        document.getElementById('main-form').style.display = 'block';

        // Load dropdown data
        try {
            await loadQueues();
            await loadUsers();
        } catch (e) {
            document.getElementById('result').innerHTML = `<b style="color:red;">API error:</b> ${e.message}`;
        }
    }
};

async function fetchAll(url) {
    let items = [];
    let page = 1, pageSize = 100, total = 0;
    do {
        const res = await fetch(`${url}?pageNumber=${page}&pageSize=${pageSize}`, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        if (!res.ok) throw new Error('API Error: ' + res.status);
        const data = await res.json();
        total = data.total || (data.entities ? data.entities.length : 0);
        items = items.concat(data.entities || []);
        page++;
    } while (items.length < total);
    return items;
}

async function loadQueues() {
    const queues = await fetchAll('https://api.mypurecloud.ie/api/v2/routing/queues');
    const select = document.getElementById('queue-select');
    select.innerHTML = queues.map(q =>
        `<option value="${q.id}">${q.name}</option>`
    ).join('');
}

async function loadUsers() {
    const users = await fetchAll('https://api.mypurecloud.ie/api/v2/users');
    const select = document.getElementById('user-select');
    select.innerHTML = users.map(u =>
        `<option value="${u.id}">${u.name}</option>`
    ).join('');
}

document.getElementById('create-btn').onclick = async () => {
    const queueId = document.getElementById('queue-select').value;
    const userId = document.getElementById('user-select').value;
    const externalRef = document.getElementById('external-ref').value;
    const body = {
        queueId,
        provider: 'QualityForm',
        direction: 'INBOUND',
        fromName: 'External Work',
        attributes: { 'External Link': externalRef },
        toAddress: "dummy@no-reply.com",
        subject: "External Dummy Work",
        textBody: "Please complete this external work via the provided link."
    };

    document.getElementById('result').innerHTML = "Creating interaction...";

    try {
        // Step 1: Create the conversation
        const res = await fetch('https://api.mypurecloud.ie/api/v2/conversations/emails', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
        });
        if (!res.ok) throw new Error('Create failed: ' + res.status);
        const data = await res.json();
        const conversationId = data.id;

        // Step 2: Get all participants for the conversation
        const convoRes = await fetch(
            `https://api.mypurecloud.ie/api/v2/conversations/emails/${conversationId}`,
            { headers: { 'Authorization': `Bearer ${accessToken}` } }
        );
        const convoData = await convoRes.json();

        // Find the participant to assign (purpose: "acd")
        const acdParticipant = (convoData.participants || []).find(
            p => p.purpose === "acd"
        );
        if (!acdParticipant) throw new Error("Could not find ACD participant to assign");
        const participantId = acdParticipant.id;

        // Step 3: PATCH to assign the agent
        const patchBody = [
            { op: "replace", path: "/userId", value: userId }
        ];
        const patchRes = await fetch(
            `https://api.mypurecloud.ie/api/v2/conversations/emails/${conversationId}/participants/${participantId}`,
            {
                method: 'PATCH',
                headers: {
                    'Authorization': `Bearer ${accessToken}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(patchBody)
            }
        );
        if (!patchRes.ok) throw new Error("Assignment failed: " + patchRes.status);

        document.getElementById('result').innerHTML =
            `<b>Success!</b> Assigned to agent.<br>Conversation ID: <code>${conversationId}</code>`;
    } catch (err) {
        document.getElementById('result').innerHTML =
            `<b style="color:red;">Error:</b> ${err.message}`;
    }
};
</script>
</body>
</html>
