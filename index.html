<!DOCTYPE html>
<html lang="en">
<head>
  <!-- [Previous head content remains the same] -->
</head>
<body>
  <!-- [Previous body content remains the same until the script] -->

  <script>
    // [Previous OAuth and initialization code remains the same until createInteraction]

    async function createInteraction(token) {
      const queueId = document.getElementById('queueSelect').value;
      const userId = document.getElementById('userSelect').value;
      const externalReference = document.getElementById('externalReference').value;
      const statusMessage = document.getElementById('statusMessage');
      const interactionLink = document.getElementById('interactionLink');

      // Reset status
      statusMessage.innerText = '';
      statusMessage.className = '';
      interactionLink.style.display = 'none';

      try {
        // 1. Create a callback interaction (more stable for persistent work items)
        const callbackResponse = await fetch('https://api.mypurecloud.ie/api/v2/conversations/callbacks', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            queueId: queueId,
            name: externalReference || 'External Work Item',
            callbackNumbers: ['+1234567890'], // Dummy number
            callbackUserName: 'System Generated',
            externalContactId: '00000000-0000-0000-0000-000000000000',
            attributes: {
              'ExternalReference': externalReference,
              'ExternalWork': 'true',
              'subject': externalReference || 'External Work Item'
            }
          })
        });

        if (!callbackResponse.ok) {
          throw new Error(`Error creating callback: ${callbackResponse.status} ${callbackResponse.statusText}`);
        }

        const callback = await callbackResponse.json();
        const conversationId = callback.conversation.id;

        // 2. Assign directly to user (alternative approach)
        const assignResponse = await fetch(`https://api.mypurecloud.ie/api/v2/conversations/${conversationId}/participants`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: userId,
            purpose: 'agent'
          })
        });

        if (!assignResponse.ok) {
          throw new Error(`Error assigning user: ${assignResponse.status} ${assignResponse.statusText}`);
        }

        // Show success message
        statusMessage.innerText = 'Work item created successfully! It will remain active until resolved.';
        interactionLink.href = `https://apps.mypurecloud.ie/conversation/${conversationId}`;
        interactionLink.style.display = 'inline-block';
        interactionLink.innerText = `Open Work Item (ID: ${conversationId})`;

      } catch (error) {
        console.error('Error:', error);
        statusMessage.innerText = `Error: ${error.message}`;
        statusMessage.className = 'error';
      }
    }
  </script>
</body>
</html>
