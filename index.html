<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>External Work Contact</title>
  <link href="https://fonts.googleapis.com/css2?family=Proxima+Nova&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Proxima Nova',Arial,sans-serif; margin:20px; padding:20px }
    #logo-container { text-align:center; margin-bottom:20px }
    #logo { width:300px }
    label { display:block; margin-top:10px; font-weight:bold }
    select, input, button { width:100%; max-width:300px; padding:8px; margin-top:5px }
    #statusMessage { margin-top:20px; font-style:italic; color:#2a7f62 }
    .required:after { content:" *"; color:red }
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/ExternalWorkCreation/main/Consultinglogo.png" alt="Company Logo">
  </div>

  <h1>External Work Contact</h1>

  <label for="queueSelect" class="required">Select Queue:</label>
  <select id="queueSelect" required></select>

  <label for="userSelect" class="required">Select Agent:</label>
  <select id="userSelect" required></select>

  <label for="contactMethod">Contact Method:</label>
  <select id="contactMethod">
    <option value="email">Email</option>
    <option value="sms">SMS</option>
  </select>

  <label for="emailAddress">Email Address:</label>
  <input type="email" id="emailAddress" placeholder="e.g. user@example.com">

  <label for="phoneNumber">Phone Number:</label>
  <input type="tel" id="phoneNumber" placeholder="e.g. +441234567890">

  <label for="subject">Subject (for email):</label>
  <input type="text" id="subject" placeholder="Subject line for email">

  <label for="initialMessage">Initial Message:</label>
  <textarea id="initialMessage" rows="3" style="width:100%; max-width:300px" placeholder="Optional initial message"></textarea>

  <button id="createInteractionBtn">Create Outbound Interaction</button>
  <div id="statusMessage"></div>

  <script>
    // --- CONFIG ---
    const clientId     = '96d0dde8-a96f-44fb-b039-5e578a1e78b3';
    const redirectUri  = 'https://gmcglynn88.github.io/Outbound-Chat/';
    const responseType = 'token';
    const scopes       = [
      'conversation.email.create',
      'conversation.messaging.create',
      'conversation.participants.create',
      'routing.queues.read',
      'directory.users.read'
    ];
    const messagingIntegrationId = '<YOUR_INTEGRATION_ID>'; // for SMS
    const provider               = 'sms'; // or "whatsapp", etc.
    // ----------------

    const oauthUrl = [
      'https://login.mypurecloud.ie/oauth/authorize?',
      `client_id=${clientId}`,
      `response_type=${responseType}`,
      `redirect_uri=${encodeURIComponent(redirectUri)}`,
      `scope=${encodeURIComponent(scopes.join(' '))}`,
      'state=multiDemo'
    ].join('&');

    document.addEventListener('DOMContentLoaded', () => {
      const hash   = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const token  = params.get('access_token');
      if (!token) return window.location.replace(oauthUrl);
      initializeApp(token);
      
      // Show/hide fields based on contact method
      document.getElementById('contactMethod').addEventListener('change', function() {
        const method = this.value;
        document.getElementById('emailAddress').style.display = method === 'email' ? 'block' : 'none';
        document.querySelector('label[for="emailAddress"]').style.display = method === 'email' ? 'block' : 'none';
        document.getElementById('phoneNumber').style.display = method === 'sms' ? 'block' : 'none';
        document.querySelector('label[for="phoneNumber"]').style.display = method === 'sms' ? 'block' : 'none';
        document.getElementById('subject').style.display = method === 'email' ? 'block' : 'none';
        document.querySelector('label[for="subject"]').style.display = method === 'email' ? 'block' : 'none';
      });
      
      // Trigger initial state
      document.getElementById('contactMethod').dispatchEvent(new Event('change'));
    });

    function initializeApp(token) {
      populateDropdowns(token);
      document.getElementById('createInteractionBtn')
              .addEventListener('click', () => connectExternal(token));
    }

    async function populateDropdowns(token) {
      try {
        const queues = await fetchAllPages('https://api.mypurecloud.ie/api/v2/routing/queues', token);
        const users  = await fetchAllPages('https://api.mypurecloud.ie/api/v2/users?expand=presence', token);
        
        const qSel = document.getElementById('queueSelect');
        const uSel = document.getElementById('userSelect');
        
        // Sort queues alphabetically
        queues.sort((a, b) => a.name.localeCompare(b.name));
        queues.forEach(q => qSel.add(new Option(q.name, q.id)));
        
        // Sort users alphabetically and filter for available agents if needed
        users.sort((a, b) => a.name.localeCompare(b.name));
        users.forEach(u => uSel.add(new Option(u.name, u.id)));
        
      } catch (error) {
        document.getElementById('statusMessage').innerText = `Error loading data: ${error.message}`;
        console.error('Error populating dropdowns:', error);
      }
    }

    async function fetchAllPages(url, token) {
      let items = [], page = 1, more = true;
      while (more) {
        const res = await fetch(`${url}?pageNumber=${page}&pageSize=25`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        const js = await res.json();
        items = items.concat(js.entities);
        more  = js.pageCount > page;
        page++;
      }
      return items;
    }

    async function connectExternal(token) {
      const queueId      = document.getElementById('queueSelect').value;
      const userId       = document.getElementById('userSelect').value;
      const contactMethod = document.getElementById('contactMethod').value;
      const emailAddr    = document.getElementById('emailAddress').value.trim();
      const phoneNum     = document.getElementById('phoneNumber').value.trim();
      const subject      = document.getElementById('subject').value.trim();
      const initialMessage = document.getElementById('initialMessage').value.trim();
      const statusEl     = document.getElementById('statusMessage');

      // Validate inputs
      if (contactMethod === 'email' && !emailAddr) {
        return statusEl.innerText = '‚ö†Ô∏è Please enter an email address.';
      }
      if (contactMethod === 'sms' && !phoneNum) {
        return statusEl.innerText = '‚ö†Ô∏è Please enter a phone number.';
      }
      if (!queueId || !userId) {
        return statusEl.innerText = '‚ö†Ô∏è Please select both a queue and an agent.';
      }

      statusEl.innerText = 'üöÄ Creating outbound interaction...';

      try {
        let convo;

        if (contactMethod === 'email') {
          // Email conversation
          const resp = await fetch('https://api.mypurecloud.ie/api/v2/conversations/emails', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type':  'application/json'
            },
            body: JSON.stringify({
              queueId,
              toAddress: emailAddr,
              fromName: 'External Work',
              subject: subject || 'Follow up',
              direction: 'outbound',
              attributes: {
                source: 'external_work_tool',
                interactionType: 'outbound_email'
              }
            })
          });
          if (!resp.ok) {
            const error = await resp.json();
            throw new Error(`Email API ${resp.status} ${resp.statusText}: ${error.message}`);
          }
          convo = await resp.json();
        } else {
          // SMS conversation
          const resp = await fetch('https://api.mypurecloud.ie/api/v2/conversations/messaging/conversations', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type':  'application/json'
            },
            body: JSON.stringify({
              queueId,
              messagingSetting: { integrationId: messagingIntegrationId },
              toAddress: phoneNum,
              provider,
              direction: 'outbound',
              attributes: {
                source: 'external_work_tool',
                interactionType: 'outbound_sms'
              },
              initialMessage: initialMessage ? {
                textBody: initialMessage,
                isActive: true
              } : undefined
            })
          });
          if (!resp.ok) {
            const error = await resp.json();
            throw new Error(`Messaging API ${resp.status} ${resp.statusText}: ${error.message}`);
          }
          convo = await resp.json();
        }

        // Add agent to the conversation
        const partUrl = convo.hasOwnProperty('fromAddress')
          ? `https://api.mypurecloud.ie/api/v2/conversations/emails/${convo.id}/participants`
          : `https://api.mypurecloud.ie/api/v2/conversations/messaging/conversations/${convo.id}/participants`;

        const partResp = await fetch(partUrl, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type':  'application/json'
          },
          body: JSON.stringify({ 
            userId, 
            purpose: 'agent',
            attributes: {
              assignedBy: 'external_work_tool'
            }
          })
        });
        if (!partResp.ok) {
          const error = await partResp.json();
          throw new Error(`Participant API ${partResp.status} ${partResp.statusText}: ${error.message}`);
        }

        statusEl.innerHTML = `‚úÖ <strong>Outbound interaction created successfully!</strong><br>
                             Conversation ID: ${convo.id}<br>
                             Assigned to agent: ${document.getElementById('userSelect').selectedOptions[0].text}<br>
                             <small>The interaction will appear in the agent's workspace.</small>`;
        
        // Optionally clear form for next interaction
        // document.getElementById('emailAddress').value = '';
        // document.getElementById('phoneNumber').value = '';
        // document.getElementById('initialMessage').value = '';
      }
      catch (err) {
        console.error('Error creating interaction:', err);
        statusEl.innerHTML = `‚ùå <strong>Failed to create interaction:</strong><br>${err.message}`;
      }
    }
  </script>
</body>
</html>
