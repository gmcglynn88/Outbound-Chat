<script>
async function createInteraction(token) {
  const queueId = document.getElementById('queueSelect').value;
  const userId = document.getElementById('userSelect').value;
  const externalReference = document.getElementById('externalReference').value;
  const statusElement = document.getElementById('statusMessage');

  try {
    // 1. Create the messaging conversation
    const createResponse = await fetch('https://api.mypurecloud.ie/api/v2/conversations/messages', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        queueId: queueId,
        toAddress: 'external-work@yourdomain.com', // Can be any valid email format
        toAddressMessengerType: 'sms', // This helps create a persistent interaction
        useExistingConversation: false, // Force new conversation
        externalContactId: '00000000-0000-0000-0000-000000000000', // Required dummy contact
        useUserFromAddress: false
      })
    });

    if (!createResponse.ok) throw new Error(`Creation failed: ${await createResponse.text()}`);
    const conversation = await createResponse.json();
    const conversationId = conversation.id;

    // 2. Add initial message content
    const messageResponse = await fetch(`https://api.mypurecloud.ie/api/v2/conversations/messages/${conversationId}/messages`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        text: externalReference || 'External Work Item',
        bodyType: 'standard',
        attributes: {
          'ExternalReference': externalReference,
          'ExternalWork': 'true'
        }
      })
    });

    // 3. Assign to agent (alternative method that works better for messaging)
    const participantResponse = await fetch(`https://api.mypurecloud.ie/api/v2/conversations/${conversationId}/participants`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        userId: userId,
        purpose: 'agent',
        attributes: {
          'role': 'agent'
        }
      })
    });

    // 4. Verify and display results
    const verifyResponse = await fetch(`https://api.mypurecloud.ie/api/v2/conversations/${conversationId}`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    const verifiedConv = await verifyResponse.json();

    statusElement.innerHTML = `
      <div style="color:green">
        Work item created successfully!<br>
        State: ${verifiedConv.state}<br>
        <a href="https://apps.mypurecloud.ie/conversation/${conversationId}" target="_blank">
          Open in PureCloud (ID: ${conversationId})
        </a>
      </div>
    `;

  } catch (error) {
    console.error('Error:', error);
    statusElement.innerHTML = `
      <div style="color:red">
        Failed to create work item: ${error.message}<br>
        ${error.response ? await error.response.text() : ''}
      </div>
    `;
  }
}
</script>
