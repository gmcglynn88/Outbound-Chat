<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Genesys Targeted Interaction Creator</title>
    <style>
        /* Your existing styles remain unchanged */
    </style>
</head>
<body>
    <!-- Your existing HTML remains unchanged -->
    
<script>
// Your existing constants and authentication code remain the same

async function directAssignToAgent(conversationId, userId) {
    // First get all participants to find the agent
    const participantsUrl = `https://api.mypurecloud.ie/api/v2/conversations/emails/${conversationId}/participants`;
    const participantsRes = await fetch(participantsUrl, {
        headers: { 'Authorization': `Bearer ${accessToken}` }
    });
    
    if (!participantsRes.ok) {
        const error = await participantsRes.json();
        throw new Error(`Failed to get participants: ${error.message}`);
    }
    
    const participants = await participantsRes.json();
    const agentParticipant = participants.find(p => p.purpose === 'agent');
    
    if (!agentParticipant) {
        throw new Error('No agent participant found in conversation');
    }

    // Prepare the exact participant update schema you provided
    const updatePayload = {
        wrapup: {
            code: "DIRECT_ASSIGN",
            name: "Direct Assignment",
            notes: "Assigned directly to agent via tool",
            tags: ["direct_assignment"],
            durationSeconds: 0,
            endTime: new Date().toISOString(),
            provisional: true,
            disableEndTimeUpdates: true
        },
        state: "connected", // Keeps the conversation active
        recording: true,    // Ensures recording continues
        muted: false,       // Not muted so agent can interact
        confined: false,    // Not confined
        held: false,        // Not on hold
        wrapupSkipped: true // Skip wrapup since just assigned
    };

    const updateUrl = `https://api.mypurecloud.ie/api/v2/conversations/emails/${conversationId}/participants/${agentParticipant.id}`;
    
    const response = await fetch(updateUrl, {
        method: 'PATCH',
        headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(updatePayload)
    });
    
    if (!response.ok) {
        const error = await response.json();
        throw new Error(`Failed to assign to agent: ${error.message}`);
    }
    
    return response.json();
}

document.getElementById('create-btn').onclick = async () => {
    const queueId = "2fec5d88-bbf0-41bb-ab5a-95199438a2aa";
    const userId = document.getElementById('user-select').value;
    const interactionLabel = document.getElementById('interaction-label').value;
    
    if (!interactionLabel) {
        showError('Please enter a reference for the interaction');
        return;
    }
    
    showLoader(true);
    document.getElementById('result').style.display = 'none';
    
    try {
        // Step 1: Create the email conversation using the exact schema provided
        const conversationBody = {
            queueId: queueId,
            provider: "purecloud",
            priority: 1,
            attributes: {
                "targetedAgentId": userId,
                "isForcedAssignment": "true",
                "interactionLabel": interactionLabel,
                "skipQueue": "true",
                "createdVia": "Targeted Interaction Tool"
            },
            toAddress: "support@company.com",
            fromAddress: "targeted@company.com",
            fromName: interactionLabel,
            subject: interactionLabel,
            direction: "inbound",
            htmlBody: `
                <div style="font-family: Aptos, sans-serif;">
                    <h3 style="color: #63AB8F;">${interactionLabel}</h3>
                    <p>This interaction was directly assigned to you.</p>
                    <p style="color: #666; font-size: 0.9em;">
                        Created: ${new Date().toLocaleString()}
                    </p>
                </div>
            `,
            textBody: `Directly assigned interaction: ${interactionLabel}`,
            utilizationLabel: "direct_assignment"
        };

        const convRes = await fetch('https://api.mypurecloud.ie/api/v2/conversations/emails', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(conversationBody)
        });
        
        if (!convRes.ok) {
            const error = await convRes.json();
            throw new Error(`Conversation creation failed: ${error.message}`);
        }
        
        const conversation = await convRes.json();
        
        // Step 2: Immediately assign to selected agent
        await directAssignToAgent(conversation.id, userId);
        
        // Step 3: Verify assignment
        const verifyUrl = `https://api.mypurecloud.ie/api/v2/conversations/emails/${conversation.id}`;
        const verifyRes = await fetch(verifyUrl, {
            headers: { 'Authorization': `Bearer ${accessToken}` }
        });
        
        if (!verifyRes.ok) {
            throw new Error('Failed to verify assignment');
        }
        
        const verifiedConv = await verifyRes.json();
        const agentName = document.getElementById('user-select').selectedOptions[0].text;
        
        showSuccess(`
            <strong>Successfully created and assigned</strong>
            <p>Interaction <strong>${interactionLabel}</strong> is now with ${agentName}</p>
            <p style="font-size: 0.9em; color: #666;">
                Conversation ID: ${conversation.id}<br>
                Queue association maintained
            </p>
        `);
        
    } catch (err) {
        showError(`
            <strong>Assignment failed</strong>
            <p>${err.message}</p>
            <p style="font-size: 0.9em; color: #666;">
                Check console for details and verify in Genesys Admin.
            </p>
        `);
        console.error('Detailed error:', err);
    } finally {
        showLoader(false);
    }
};
</script>
</body>
</html>
